<?xml version="1.0" encoding="utf-8"?>
<s:HGroup xmlns:fx="http://ns.adobe.com/mxml/2009" 
		  xmlns:s="library://ns.adobe.com/flex/spark" paddingBottom="10" paddingLeft="10" paddingRight="10" paddingTop="10"
		  xmlns:mx="library://ns.adobe.com/flex/mx" width="100%" height="100%" creationComplete="creationCompleteHandler(event)">
	<fx:Script>
		<![CDATA[
			import com.adobe.cairngorm.control.CairngormEventDispatcher;
			import com.module.events.DataListEvent;
			import com.module.events.ItemsTransEvent;
			import com.module.events.UserEvent;
			import com.module.renderer.PurchaseOrdRenderer;
			import com.variables.AccessVars;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.events.CloseEvent;
			import mx.events.FlexEvent;
			import mx.events.PropertyChangeEvent;
			import mx.managers.PopUpManager;
			import mx.printing.FlexPrintJob;
			import mx.printing.FlexPrintJobScaleType;
			
			import spark.components.Application;
			import spark.events.GridEvent;
			import spark.events.GridItemEditorEvent;
			import spark.events.IndexChangeEvent;
			import spark.events.TextOperationEvent;
			private var _totalQty:int = 0;
			public var _tempData:Object;
			public var purReqID:String = "";
			public var _type:int = 0; 
			public var theOwner:Object;
			
			protected function creationCompleteHandler(event:FlexEvent):void
			{
				var log:ItemsTransEvent = new ItemsTransEvent(ItemsTransEvent.SEARCH_PRODUCT,{searchstr:"",sBox:this})
				CairngormEventDispatcher.getInstance().dispatchEvent(log);
				
				var log2:DataListEvent = new DataListEvent(DataListEvent.GET_BRANCH_LIST,{pBox:this})
				CairngormEventDispatcher.getInstance().dispatchEvent(log2);
				
				var log3:ItemsTransEvent = new ItemsTransEvent(ItemsTransEvent.GET_PURORD_NUMBER,{qBox:this})
				CairngormEventDispatcher.getInstance().dispatchEvent(log3);
				
				var log4:UserEvent = new UserEvent(UserEvent.GET_SUPPLIER_LIST,{qBox:this})
				CairngormEventDispatcher.getInstance().dispatchEvent(log4);
				
				dfDate.selectedDate = new Date(); 
			}
			
			public function setDataProvider(arr:ArrayCollection,type:int):void{
				if (type == 0){
					
				}else if (type == 1){
					//dataCollection = arr
					cmbDeliver.dataProvider = arr;
					//cmbDeliver.labelFunction = mycmbDeliverLabelFunction;
					cmbDeliver.selectedIndex = 0;
					//cmbDeliver.validateNow();
				}else if (type == 3){
					dg.dataProvider = arr;
					
				}else if (type == 4){
					//dataCollection = arr
					cmbSupplier.dataProvider = arr;
					//cmbSupplier.labelFunction = mycmbSupplierLabelFunction;
					//cmbSupplier.validateNow();
				}
			}
			
			public function setSelectedSupplier(supID:String):void{
				var i:int=0;
				for each (var item:Object in cmbSupplier.dataProvider as ArrayCollection){
					trace(item.supID," == ",supID)
					if (item.supID == supID){
						cmbSupplier.selectedItem = item;
						cmbSupplier.selectedIndex = i;
						break;
					}	
					i++;
				}
			}
			public function setSelectedDelivery(branchID:String):void{
				var i:int=0;
				for each (var item:Object in cmbDeliver.dataProvider as ArrayCollection){
					trace(item.branchID," == ",branchID)
					if (item.branchID == branchID){
						cmbDeliver.selectedItem = item;
						cmbDeliver.selectedIndex = i;
						break;
					}	
					i++;
				}
			}
			
			private var _arrCol:ArrayCollection;
			public function set dataCollection(arrCol:ArrayCollection):void{
				_arrCol = arrCol
				
				if (dgSearch.numElements > 0){
					dgSearch.removeAllElements();
				}
				
				if (arrCol.length > 0){
					var itemUser:PurchaseOrdRenderer;
					for each (var obj:Object in arrCol){
						itemUser = new PurchaseOrdRenderer()
						itemUser.data = obj;
						itemUser.theBox = this
						dgSearch.addElement(itemUser);
					}
				}
			}
			
			
			
			
			protected function btnAdd_keyUpHandler(event:KeyboardEvent):void
			{
				if(event.keyCode == Keyboard.ENTER)
					(event.target as Button).dispatchEvent(new MouseEvent(MouseEvent.CLICK));
			}
			
			
			
			protected function CheckOutclickHandler(event:MouseEvent):void
			{
				if (dg.dataProviderLength == 0 )return;
				if (cmbSupplier.selectedIndex == -1){
					Alert.show("Please select a supplier","No Supplier Selected");
					return;
				}
				var obj:Object = {}
				obj.purReqID = purReqID;//cmbQuote.selectedItem.custID;
				obj.supID = cmbSupplier.selectedItem.supID;
				obj.branchID = _tempData.branchID;
				obj.delID = cmbDeliver.selectedItem.branchID;
				
				obj.dateTrans = setDateFormat(dfDate.selectedDate);
				//obj.vat = txtVat.text;
				var strItem:Array = new Array();
				for each (var item:Object in dg.dataProvider){
					if (item.isSelected=="1")
						strItem.push(item.prd_prodID+"|"+item.qty+"|"+item.total+"|"+item.prdID);
				}
				obj.purOrdDetails = strItem.join("||");
				obj.pBox = this;
				trace("purOrdDetails", obj.purOrdDetails)
				 var log2:ItemsTransEvent = new ItemsTransEvent(ItemsTransEvent.ADD_PURORD,obj)
				CairngormEventDispatcher.getInstance().dispatchEvent(log2); 
				//printPrevPO()
				//btnPrint.enabled = true;
			}
			
			private function setDateFormat(d:Date):String{
				var strDate:String="";
				//strDate = String(d.month+1)+"/"+d.date+"/"+d.fullYear;
				strDate = d.fullYear+"-"+String(d.month+1)+"-"+d.date;
				return strDate;
			}
			
			public function updateCurrentPO():void{
				var item:Object;
				for (var i:int = (dg.dataProvider as ArrayCollection).length-1; i >=0 ; i--){
					item = (dg.dataProvider as ArrayCollection).getItemAt(i);
					if (item.isSelected=="1")
						(dg.dataProvider as ArrayCollection).removeItemAt(i);
					else{
						item.isSelected = "1";
						dg.dataProvider.itemUpdated(item);
					}
				}
				trace("(dg.dataProvider as ArrayCollection).length:",(dg.dataProvider as ArrayCollection).length)
				var num:int = 1;
				for each (var item:Object in dg.dataProvider){
					item.num = num;
					item.isSelected = "1";
					dg.dataProvider.itemUpdated(item);
					num++;
				}
				setDataProvider((dg.dataProvider as ArrayCollection),3);
				if ((dg.dataProvider as ArrayCollection).length==0){
					clearFields(null);
					mainCont.enabled = false;
					btnCheckOut.visible = btnCheckOut.includeInLayout = false;
					btnEdit.visible = btnEdit.includeInLayout = false;
					Alert.show("All Items are fully serve on Requisition No.:"+_tempData.reqNo,"Requisition Complete");
					var PO_renderer:PurchaseOrdRenderer;
					for (i=dgSearch.numElements-1; i >= 0; i-- ){
						PO_renderer = (dgSearch.getElementAt(i) as PurchaseOrdRenderer);
						if (PO_renderer.data == _tempData){
							dgSearch.removeElementAt(i);
							break;							
						}
					}
				}
					
				var log3:ItemsTransEvent = new ItemsTransEvent(ItemsTransEvent.GET_PURORD_NUMBER,{qBox:this})
				CairngormEventDispatcher.getInstance().dispatchEvent(log3);
			}
			
			protected function printPrevPO():void
			{
				/*var printJob:FlexPrintJob = new FlexPrintJob();
				if (printJob.start() != true) return;
				printJob.addObject(cont, FlexPrintJobScaleType.SHOW_ALL); 
				printJob.send();*/
				var _printBox:PrintPrevBox = new PrintPrevBox();
				_printBox.boxType = this;
				_printBox.orderTypeID = 0;
				_printBox.width = AccessVars.instance().mainApp.width-5;
				_printBox.height = AccessVars.instance().mainApp.height-5;
				PopUpManager.addPopUp(_printBox,this,true);
			}
			
			public function clearFields(event:MouseEvent):void{
				
				txtBranch.text = "";
				txtPONo.text = "";
				txtSupInvNo.text = "";
				dfDate.selectedDate = new Date();
				dfInvDate.selectedDate = new Date();
				
				dg.dataProvider = null;
				txtPrepBy.text = "";
				txtCheckBy.text = "";
			}
			
			protected function btnNewclickHandler(event:MouseEvent):void
			{
				if (dg.dataProvider != null){
					Alert.show("Are you sure to create a new Purchase Order?","Purchase Order not empty",Alert.YES|Alert.NO,null,newSalesHandler,null,Alert.NO);
				}else{
					_type = 0;
					mainCont.enabled = true;
					btnCheckOut.label = "Submit Purchase Order";
					btnCheckOut.visible = btnCheckOut.includeInLayout = true;
					btnEdit.visible = btnEdit.includeInLayout = false;
					clearFields(null);
					//btnPrint.enabled = false;
					var log3:ItemsTransEvent = new ItemsTransEvent(ItemsTransEvent.GET_PURORD_NUMBER,{qBox:this})
					CairngormEventDispatcher.getInstance().dispatchEvent(log3);
				}
			}
			protected function editClickHandler(event:MouseEvent):void
			{
				_type = 0;
				//btnCheckOut.label = "Save Purchase Order Changes";
				btnCheckOut.visible = btnCheckOut.includeInLayout = true;
				mainCont.enabled = true;
			}
			
			private function newSalesHandler(event:CloseEvent):void{
				if (event.detail == Alert.YES){
					_type = 0;
					mainCont.enabled = true;
					btnCheckOut.label = "Submit Purchase Order";
					btnCheckOut.visible = btnCheckOut.includeInLayout = true;
					btnEdit.visible = btnEdit.includeInLayout = false;
					clearFields(null);
					//btnPrint.enabled = false;
					var log3:ItemsTransEvent = new ItemsTransEvent(ItemsTransEvent.GET_PURORD_NUMBER,{qBox:this})
					CairngormEventDispatcher.getInstance().dispatchEvent(log3);
				}
			}
			
			
			
			protected function SearchClickHandler(event:MouseEvent):void
			{				
				var log2:ItemsTransEvent = new ItemsTransEvent(ItemsTransEvent.SEARCH_PURORD,{searchstr:txtSearchStr.text,qBox:this})
				CairngormEventDispatcher.getInstance().dispatchEvent(log2);
			}
						
			
			protected function dg_gridDoubleClickHandler(event:GridEvent):void
			{
				if (event.column.columnIndex == 2){
					event.grid.dataGrid.startItemEditorSession(event.rowIndex, event.columnIndex);
				}
			}
			
			protected function dg_gridItemEditorSessionSave(event:GridItemEditorEvent):void
			{
								
			}
			
			
			
		]]>
	</fx:Script>
	<fx:Declarations>
		<mx:NumberFormatter id="numFmttr" precision="2" useThousandsSeparator="true"  />
	</fx:Declarations>
	<!--<s:Label text="Purchase Order" fontWeight="bold" fontSize="18" fontStyle="italic"/>-->
	<s:HGroup width="30%" height="100%" maxWidth="350">
		<s:BorderContainer width="100%" height="100%" cornerRadius="10" borderStyle="inset">
			<s:layout>
				<s:VerticalLayout paddingTop="5" paddingLeft="2" paddingRight="2" paddingBottom="5"/>
			</s:layout>
			<s:borderStroke> 
				<mx:SolidColorStroke 
					color="{AccessVars.instance().borderStrokeColor}" 
					weight="2"/> 
			</s:borderStroke> 
			<s:HGroup width="100%" horizontalAlign="left" verticalAlign="middle" height="30">
				<s:Label text="Search"/>
				<s:TextInput prompt="[PO No. / Supplier]" id="txtSearchStr" enter="SearchClickHandler(null)" width="180"/>
				<s:Button label="Search" click="SearchClickHandler(event)"/>
			</s:HGroup>
			<s:HGroup width="100%" fontSize="14"  fontWeight="bold" gap="2">
				<s:Label text="PO No." width="30%" backgroundColor="{AccessVars.instance().headerBgColor}" textAlign="center" paddingTop="5" paddingBottom="5" color="{AccessVars.instance().headerFontColor}"/>
				<s:Label text="Supplier" width="45%" backgroundColor="{AccessVars.instance().headerBgColor}" textAlign="center" paddingTop="5" paddingBottom="5" color="{AccessVars.instance().headerFontColor}"/>
				<s:Label text="Date" width="25%" backgroundColor="{AccessVars.instance().headerBgColor}" textAlign="center" paddingTop="5" paddingBottom="5" color="{AccessVars.instance().headerFontColor}"/>
			</s:HGroup>
			<s:Group width="100%" height="100%">
				<s:Scroller width="100%" height="100%">
					<s:VGroup id="dgSearch" gap="2" width="100%" height="100%" contentBackgroundAlpha="1" contentBackgroundColor="0xCCCCCC" clipAndEnableScrolling="true"/>
				</s:Scroller>
			</s:Group>
		</s:BorderContainer>
	</s:HGroup>
	<s:VGroup id="cont" width="70%" height="100%" paddingBottom="5" paddingTop="5" paddingLeft="5" paddingRight="5">
		<s:VGroup id="mainCont" width="100%" height="100%" enabled="false">
			<s:BorderContainer width="100%" cornerRadius="10" borderStyle="inset" >
				<s:borderStroke> 
					<mx:SolidColorStroke 
						color="{AccessVars.instance().borderStrokeColor}" 
						weight="2"/> 
				</s:borderStroke> 
				<s:HGroup  width="100%" height="100%" fontSize="16" verticalAlign="middle">
					<s:VGroup  width="45%" paddingBottom="10" paddingTop="10" paddingLeft="25" paddingRight="25">
						<s:HGroup width="100%" verticalAlign="middle">
							<s:Label text="Branch" width="90" textAlign="right"/>
							<s:TextInput id="txtBranch" width="100%" />
						</s:HGroup>
						<s:HGroup width="100%" verticalAlign="middle">
							<s:Label text="PO No." width="90" textAlign="right"/>
							<s:TextInput id="txtPONo" width="100%" />
						</s:HGroup>
					</s:VGroup>
					
					<s:VGroup  width="35%" paddingBottom="5" paddingTop="5" paddingLeft="5" paddingRight="5">
						<s:HGroup width="100%" verticalAlign="middle">
							<s:Label text="Supplier's Invoice No." width="130" textAlign="right"/>
							<s:TextInput id="txtSupInvNo" width="100%" editable="false"/>
						</s:HGroup>	
						<s:HGroup width="100%" verticalAlign="middle">
							<s:Label width="130" text="Invoice Date" textAlign="right"/>
							<mx:DateField id="dfInvDate" width="100%" showToday="true"/>
						</s:HGroup>						
					</s:VGroup>
					<s:VGroup  width="35%" paddingBottom="5" paddingTop="5" paddingLeft="5" paddingRight="5">
						<s:HGroup width="100%" verticalAlign="middle">
							<s:Label text="WR No." width="50" textAlign="right"/>
							<s:TextInput id="txtWRNo" width="100%" editable="false"/>
						</s:HGroup>	
						<s:HGroup width="100%" verticalAlign="middle">
							<s:Label width="50" text="Date" textAlign="right"/>
							<mx:DateField id="dfDate" width="100%" showToday="true"/>
						</s:HGroup>						
					</s:VGroup>
				</s:HGroup>
			</s:BorderContainer>
			<s:Spacer height="5"/>
			<s:DataGrid id="dg" width="100%" height="100%" sortableColumns="false" textAlign="center" fontSize="12" editable="true"
						gridDoubleClick="dg_gridDoubleClickHandler(event)" doubleClickEnabled="true" gridItemEditorSessionSave="dg_gridItemEditorSessionSave(event)">
				<s:columns>
					<s:ArrayList>
						<s:GridColumn width="40" dataField="num" headerText="No." editable="false"/>
						<s:GridColumn dataField="qty" headerText="Qty" width="40"  editable="true">
							<s:headerRenderer>
								<fx:Component>
									<s:DefaultGridHeaderRenderer textAlign="center"/>
								</fx:Component>
							</s:headerRenderer>
						</s:GridColumn>
						<s:GridColumn dataField="unit" headerText="Unit" width="40"  editable="false"/>
						<s:GridColumn dataField="modelNo" headerText="Item / Model No." width="150"  editable="false">
							<s:itemRenderer>
								<fx:Component>
									<s:DefaultGridItemRenderer textAlign="left"/>
								</fx:Component>
							</s:itemRenderer>
						</s:GridColumn>
						<s:GridColumn dataField="prodDesc" headerText="Description" editable="false">
							<s:itemRenderer>
								<fx:Component>
									<s:DefaultGridItemRenderer textAlign="left"/>
								</fx:Component>
							</s:itemRenderer>
						</s:GridColumn>
						<s:GridColumn dataField="pkgNo" headerText="Pkg No." width="70"  editable="false">
							<s:headerRenderer>
								<fx:Component>
									<s:DefaultGridHeaderRenderer textAlign="center"/>
								</fx:Component>
							</s:headerRenderer>
						</s:GridColumn>
						<s:GridColumn dataField="qtyRec" headerText="Qty Rcv" width="70"  editable="false">
							<s:itemRenderer>
								<fx:Component>
									<s:DefaultGridItemRenderer textAlign="right"/>
								</fx:Component>
							</s:itemRenderer>
						</s:GridColumn>
						<s:GridColumn dataField="remark" headerText="Remarks" editable="false" itemRenderer="com.module.renderer.RemarksRenderer">
							<s:headerRenderer>
								<fx:Component>
									<s:DefaultGridHeaderRenderer textAlign="center"/>
								</fx:Component>
							</s:headerRenderer>
						</s:GridColumn>
						
					</s:ArrayList>
				</s:columns>
			</s:DataGrid>
			<s:HGroup width="100%" verticalAlign="middle" gap="10" paddingLeft="20">
				<s:Label text="Prepared By" width="75" textAlign="right"/>
				<s:TextInput id="txtPrepBy" width="200" editable="false"/>
				<s:Label text="Checked By" width="75" textAlign="right"/>
				<s:TextInput id="txtCheckBy" width="200" editable="false"/>
				<s:Spacer width="100%"/>
				<s:Button id="btnAddItems" label="Add Items to Warehouse Receipt"/>
			</s:HGroup>
		</s:VGroup>		
		<mx:HRule height="5" width="100%"/>
		<s:HGroup id="hgControl" width="100%" height="50" paddingBottom="5" paddingTop="5" paddingLeft="5" paddingRight="5"
				  horizontalAlign="left" verticalAlign="middle">						
			<s:Button id="btnCheckOut" label="Submit Purchase Order" click="CheckOutclickHandler(event)" visible="false" includeInLayout="false"/>
			<s:Spacer width="100%"/>
			<s:Button id="btnNew"  label="New Receipt" click="btnNewclickHandler(event)"/>
			<s:Button id="btnEdit"  label="Update Receipt" click="editClickHandler(event)" visible="false" includeInLayout="false"/>
			<s:Button id="btnView"  label="View Listings" click="printPrevPO()" visible="false" includeInLayout="false"/>
		</s:HGroup>
	</s:VGroup>
</s:HGroup>
